<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#0f0f12">
  <link rel="manifest" href="/manifest.json">
  <title>Sa≈æetak vijesti</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #18181c;
      --border: #2a2a30;
      --text: #e8e8ec; 
      --text-muted: #9a9aa3;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --success: #22c55e;
      --error: #ef4444;
      --radius: 14px;
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      padding: clamp(16px, 5vw, 24px);
      padding-top: max(env(safe-area-inset-top), 16px);
      padding-bottom: max(env(safe-area-inset-bottom), 24px);
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 28px;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
    }

    .subtitle {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    input[type="url"] {
      width: 100%;
      padding: 14px 16px;
      font-size: 1rem;
      font-family: inherit;
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="url"]::placeholder {
      color: var(--text-muted);
    }

    input[type="url"]:focus {
      border-color: var(--accent);
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .input-row input {
      flex: 1;
      min-width: 0;
    }

    .btn-paste {
      flex-shrink: 0;
      width: 48px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s, background 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-paste:hover {
      color: var(--text);
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.08);
    }

    .btn-paste:active {
      transform: scale(0.96);
    }

    .btn-paste:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px 20px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loader {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 12px;
    }

    .summary-list {
      list-style: none;
    }

    .summary-list li {
      position: relative;
      padding-left: 20px;
      margin-bottom: 10px;
      font-size: 0.9375rem;
      line-height: 1.5;
      color: var(--text);
    }

    .summary-list li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0.5em;
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
    }

    .error-msg {
      font-size: 0.9375rem;
      color: var(--error);
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 8px;
      margin-top: 12px;
    }

    .no-api-hint {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 12px;
      padding: 12px;
      background: rgba(99, 102, 241, 0.08);
      border-radius: 8px;
      border: 1px dashed var(--border);
    }

    .screen-hidden {
      display: none !important;
    }

    #readingView {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 10;
      display: flex;
      flex-direction: column;
      padding-top: max(env(safe-area-inset-top), 12px);
      padding-bottom: max(env(safe-area-inset-bottom), 24px);
      padding-left: max(env(safe-area-inset-left), 16px);
      padding-right: max(env(safe-area-inset-right), 16px);
    }

    #readingView.screen-hidden {
      display: none !important;
    }

    .reading-header {
      flex-shrink: 0;
      margin-bottom: 16px;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 0;
      font-size: 1rem;
      font-family: inherit;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.2s;
    }

    .btn-back:hover {
      color: var(--text);
    }

    .reading-content {
      flex: 1;
      overflow: auto;
      max-width: 560px;
      margin: 0 auto;
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .reading-content .summary-list li {
      font-size: 1rem;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <section id="homeScreen">
      <header>
        <h1>Sa≈æetak vijesti</h1>
        <p class="subtitle">Zalijepi URL ƒçlanka i dobit ƒáe≈° sa≈æetak u natuknicama</p>
      </header>

      <div class="card">
        <label for="url">URL ƒçlanka</label>
        <div class="input-row">
          <input
            type="url"
            id="url"
            name="url"
            placeholder="npr. https://www.index.hr/..."
            autocomplete="url"
            inputmode="url"
          />
          <button type="button" class="btn-paste" id="btnPaste" title="Zalijepi link iz meƒëuspremnika" aria-label="Zalijepi link iz meƒëuspremnika">
            <span aria-hidden="true">üìã</span>
          </button>
        </div>
        <button type="button" class="btn" id="btn">Sa≈æmi</button>
      </div>
    </section>

    <section id="readingView" class="screen-hidden" aria-live="polite">
      <div class="reading-header">
        <button type="button" class="btn-back" id="btnBack" aria-label="Natrag na poƒçetni ekran">‚Üê Natrag</button>
      </div>
      <div class="reading-content">
        <p class="result-title">Sa≈æetak</p>
        <ul class="summary-list" id="summaryList"></ul>
        <div class="error-msg hidden" id="errorMsg"></div>
        <div class="no-api-hint hidden" id="noApiHint"></div>
      </div>
    </section>
  </div>

  <script>
    const urlInput = document.getElementById('url');
    const btn = document.getElementById('btn');
    const btnPaste = document.getElementById('btnPaste');
    const btnBack = document.getElementById('btnBack');
    const homeScreen = document.getElementById('homeScreen');
    const readingView = document.getElementById('readingView');
    const summaryList = document.getElementById('summaryList');
    const errorMsg = document.getElementById('errorMsg');
    const noApiHint = document.getElementById('noApiHint');

    function isUrlLike(str) {
      if (!str || typeof str !== 'string') return false;
      const s = str.trim();
      return /^https?:\/\//i.test(s) || /^[a-z0-9-]+\.(hr|com|org|net)[^\s]*/i.test(s);
    }

    function extractUrlFromShareParams(params) {
      const url = params.get('url');
      if (url && url.trim()) return url.trim();
      const text = params.get('text');
      if (text) {
        const t = text.trim();
        if (isUrlLike(t)) return t;
        var m = t.match(/https?:\/\/[^\s]+/);
        if (m) return m[0];
      }
      return '';
    }

    async function doSummarize() {
      const url = urlInput.value.trim();
      if (!url) {
        urlInput.focus();
        return;
      }
      btn.disabled = true;
      btn.innerHTML = '<span class="loader"></span> Sa≈æimanje...';

      try {
        const res = await fetch('/api/summarize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: url }),
        });
        const data = await res.json();

        if (!res.ok) {
          showError(data.error || 'Do≈°lo je do gre≈°ke.');
          return;
        }
        showResult(data.summary || [], data.error === 'NO_API_KEY');
      } catch (err) {
        showError('Nije moguƒáe kontaktirati server. Provjeri mre≈æu ili poku≈°aj ponovno.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sa≈æmi';
      }
    }

    function switchToReadingView() {
      homeScreen.classList.add('screen-hidden');
      readingView.classList.remove('screen-hidden');
    }

    function showResult(summary, isNoApiKey) {
      switchToReadingView();
      summaryList.innerHTML = '';
      errorMsg.classList.add('hidden');
      errorMsg.textContent = '';
      noApiHint.classList.add('hidden');
      noApiHint.textContent = '';

      if (Array.isArray(summary) && summary.length) {
        summary.forEach(function (point) {
          const li = document.createElement('li');
          li.textContent = point;
          summaryList.appendChild(li);
        });
        if (isNoApiKey) {
          noApiHint.textContent = 'Postavi OPENAI_API_KEY (u .env lokalno ili u Vercel Environment Variables).';
          noApiHint.classList.remove('hidden');
        }
      }
    }

    function showError(message) {
      switchToReadingView();
      summaryList.innerHTML = '';
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      noApiHint.classList.add('hidden');
    }

    function goBack() {
      urlInput.value = '';
      summaryList.innerHTML = '';
      errorMsg.classList.add('hidden');
      errorMsg.textContent = '';
      noApiHint.classList.add('hidden');
      noApiHint.textContent = '';
      readingView.classList.add('screen-hidden');
      homeScreen.classList.remove('screen-hidden');
      urlInput.focus();
    }

    btn.addEventListener('click', doSummarize);

    urlInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') btn.click();
    });

    btnPaste.addEventListener('click', async function handlePaste() {
      try {
        var text = await navigator.clipboard.readText();
        urlInput.value = text ? text.trim() : '';
        urlInput.focus();
      } catch (err) {
        showError('Kliknite Dopusti kada vas sustav zatra≈æi.');
      }
    });

    btnBack.addEventListener('click', goBack);

    (function initShareTarget() {
      var params = new URLSearchParams(window.location.search);
      var sharedUrl = extractUrlFromShareParams(params);
      if (sharedUrl) {
        urlInput.value = sharedUrl;
        window.history.replaceState({}, document.title, window.location.pathname || '/');
        doSummarize();
      }
    })();
  </script>
</body>
</html>
